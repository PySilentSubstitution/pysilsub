
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>Spectrometer &#8212; PySilSub 0.0.13 documentation</title>
    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="_static/alabaster.css" />
    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="_static/doctools.js"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Individual differences" href="07b_individual_differences.html" />
    <link rel="prev" title="Project notes" href="07_project_notes.html" />
   
  <link rel="stylesheet" href="_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput.container div.prompt *,
div.nboutput.container div.prompt *,
div.nbinput.container div.input_area pre,
div.nboutput.container div.output_area pre,
div.nbinput.container div.input_area .highlight,
div.nboutput.container div.output_area .highlight {
    border: none;
    padding: 0;
    margin: 0;
    box-shadow: none;
}

div.nbinput.container > div[class*=highlight],
div.nboutput.container > div[class*=highlight] {
    margin: 0;
}

div.nbinput.container div.prompt *,
div.nboutput.container div.prompt * {
    background: none;
}

div.nboutput.container div.output_area .highlight,
div.nboutput.container div.output_area pre {
    background: unset;
}

div.nboutput.container div.output_area div.highlight {
    color: unset;  /* override Pygments text color */
}

/* avoid gaps between output lines */
div.nboutput.container div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput.container,
div.nboutput.container {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput.container,
    div.nboutput.container {
        flex-direction: column;
    }
}

/* input container */
div.nbinput.container {
    padding-top: 5px;
}

/* last container */
div.nblast.container {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput.container div.prompt pre {
    color: #307FC1;
}

/* output prompt */
div.nboutput.container div.prompt pre {
    color: #BF5B3D;
}

/* all prompts */
div.nbinput.container div.prompt,
div.nboutput.container div.prompt {
    width: 4.5ex;
    padding-top: 5px;
    position: relative;
    user-select: none;
}

div.nbinput.container div.prompt > div,
div.nboutput.container div.prompt > div {
    position: absolute;
    right: 0;
    margin-right: 0.3ex;
}

@media (max-width: 540px) {
    div.nbinput.container div.prompt,
    div.nboutput.container div.prompt {
        width: unset;
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput.container div.prompt.empty {
        padding: 0;
    }

    div.nbinput.container div.prompt > div,
    div.nboutput.container div.prompt > div {
        position: unset;
    }
}

/* disable scrollbars on prompts */
div.nbinput.container div.prompt pre,
div.nboutput.container div.prompt pre {
    overflow: hidden;
}

/* input/output area */
div.nbinput.container div.input_area,
div.nboutput.container div.output_area {
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput.container div.input_area,
    div.nboutput.container div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput.container div.input_area {
    border: 1px solid #e0e0e0;
    border-radius: 2px;
    /*background: #f5f5f5;*/
}

/* override MathJax center alignment in output cells */
div.nboutput.container div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.imgmath center alignment in output cells */
div.nboutput.container div.math p {
    text-align: left;
}

/* standard error */
div.nboutput.container div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-default-inverse-fg { color: #FFFFFF; }
.ansi-default-inverse-bg { background-color: #000000; }

.ansi-bold { font-weight: bold; }
.ansi-underline { text-decoration: underline; }


div.nbinput.container div.input_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight].math,
div.nboutput.container div.output_area.rendered_html,
div.nboutput.container div.output_area > div.output_javascript,
div.nboutput.container div.output_area:not(.rendered_html) > img{
    padding: 5px;
    margin: 0;
}

/* fix copybtn overflow problem in chromium (needed for 'sphinx_copybutton') */
div.nbinput.container div.input_area > div[class^='highlight'],
div.nboutput.container div.output_area > div[class^='highlight']{
    overflow-y: hidden;
}

/* hide copybtn icon on prompts (needed for 'sphinx_copybutton') */
.prompt .copybtn {
    display: none;
}

/* Some additional styling taken form the Jupyter notebook CSS */
.jp-RenderedHTMLCommon table,
div.rendered_html table {
  border: none;
  border-collapse: collapse;
  border-spacing: 0;
  color: black;
  font-size: 12px;
  table-layout: fixed;
}
.jp-RenderedHTMLCommon thead,
div.rendered_html thead {
  border-bottom: 1px solid black;
  vertical-align: bottom;
}
.jp-RenderedHTMLCommon tr,
.jp-RenderedHTMLCommon th,
.jp-RenderedHTMLCommon td,
div.rendered_html tr,
div.rendered_html th,
div.rendered_html td {
  text-align: right;
  vertical-align: middle;
  padding: 0.5em 0.5em;
  line-height: normal;
  white-space: normal;
  max-width: none;
  border: none;
}
.jp-RenderedHTMLCommon th,
div.rendered_html th {
  font-weight: bold;
}
.jp-RenderedHTMLCommon tbody tr:nth-child(odd),
div.rendered_html tbody tr:nth-child(odd) {
  background: #f5f5f5;
}
.jp-RenderedHTMLCommon tbody tr:hover,
div.rendered_html tbody tr:hover {
  background: rgba(66, 165, 245, 0.2);
}
</style>
<section id="Spectrometer">
<h1>Spectrometer<a class="headerlink" href="#Spectrometer" title="Permalink to this heading">¶</a></h1>
<p>A spectrometer can be used to measure the spectral response of a system. A probe is pointed at the light source and the sample feeds through to the internal optical bench, which typically comprises routing mirrors, a prism or diffraction grating to separate the sample into its constituent wavelength coponents, and a sensor.</p>
<p><img alt="OceanOptics JAZ spectrometer" class="no-scaled-link" src="_images/jaz.png" style="width: 300px;" /></p>
<p>Our JAZ spectrometer has a 16-bit CCD sensor with 2048 pixels and reports wavelengths from 330-1030 nm. The raw spectrum is reported in <em>counts</em>, a unit of measurement relating to the number of photons hitting the sensor during the integration period.</p>
<section id="Obtaining-measurements">
<h2>Obtaining measurements<a class="headerlink" href="#Obtaining-measurements" title="Permalink to this heading">¶</a></h2>
<section id="python-seabreeze">
<h3><code class="docutils literal notranslate"><span class="pre">python-seabreeze</span></code><a class="headerlink" href="#python-seabreeze" title="Permalink to this heading">¶</a></h3>
<p>A good alternative to OceanOptics software is the <code class="docutils literal notranslate"><span class="pre">python-seabreeze</span></code> <a class="reference external" href="https://python-seabreeze.readthedocs.io/en/latest/#">library</a>, which enables connection to Ocean Optics spectrometers from Python and provides good functionality.</p>
<p><code class="docutils literal notranslate"><span class="pre">pip</span> <span class="pre">install</span> <span class="pre">seabreeze</span></code></p>
<p>Here’s a nice clean way to obtain and visualise a sample using seabreeze.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>

<span class="kn">from</span> <span class="nn">seabreeze</span> <span class="kn">import</span> <span class="n">spectrometers</span>


<span class="n">sns</span><span class="o">.</span><span class="n">set_style</span><span class="p">(</span><span class="s1">&#39;ticks&#39;</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">set_context</span><span class="p">(</span><span class="s1">&#39;notebook&#39;</span><span class="p">)</span>

<span class="k">try</span><span class="p">:</span>
    <span class="c1"># Connect to spectrometer</span>
    <span class="n">oo</span> <span class="o">=</span> <span class="n">spectrometers</span><span class="o">.</span><span class="n">Spectrometer</span><span class="o">.</span><span class="n">from_serial_number</span><span class="p">(</span><span class="s1">&#39;JAZA1505&#39;</span><span class="p">)</span>

    <span class="c1"># Set integration time</span>
    <span class="n">oo</span><span class="o">.</span><span class="n">integration_time_micros</span><span class="p">(</span><span class="mf">1e5</span><span class="p">)</span>  <span class="c1"># 1 s</span>

    <span class="c1"># Get reported wavelengths</span>
    <span class="n">wls</span> <span class="o">=</span> <span class="n">oo</span><span class="o">.</span><span class="n">wavelengths</span><span class="p">()</span>

    <span class="c1"># Obtain pixel intensities</span>
    <span class="n">counts</span> <span class="o">=</span> <span class="n">oo</span><span class="o">.</span><span class="n">intensities</span><span class="p">(</span>
        <span class="n">correct_dark_counts</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">correct_nonlinearity</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>

    <span class="c1"># Visualise</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">wls</span><span class="p">,</span> <span class="n">counts</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Pixel wavelength&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Counts&#39;</span><span class="p">)</span>

<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="k">raise</span> <span class="n">e</span>

<span class="k">finally</span><span class="p">:</span>
    <span class="n">oo</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/07a_spectrometer_calibration_3_0.png" src="_images/07a_spectrometer_calibration_3_0.png" />
</div>
</div>
</section>
<section id="pyplr.oceanops.OceanOptics">
<h3><code class="docutils literal notranslate"><span class="pre">pyplr.oceanops.OceanOptics</span></code><a class="headerlink" href="#pyplr.oceanops.OceanOptics" title="Permalink to this heading">¶</a></h3>
<p>This is my own extension to the <code class="docutils literal notranslate"><span class="pre">seabreeze.spectrometer.Spectrometers</span></code> class. It includes a sampling method with additional features like automatically adapting the integration time of a measurement to hit 80-90% maximum pixel saturation (where the sensor is most linear), averageing a number of scans, and boxcar smoothing.</p>
<p><code class="docutils literal notranslate"><span class="pre">pip</span> <span class="pre">install</span> <span class="pre">pyplr</span></code></p>
<p>It works in the same way and has all the same functionality, but there is a new <code class="docutils literal notranslate"><span class="pre">.sample(...)</span></code> method with some extra options.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pyplr</span> <span class="kn">import</span> <span class="n">oceanops</span>


<span class="k">try</span><span class="p">:</span>
    <span class="c1"># Connect to spectrometer</span>
    <span class="n">oo</span> <span class="o">=</span> <span class="n">oceanops</span><span class="o">.</span><span class="n">OceanOptics</span><span class="o">.</span><span class="n">from_serial_number</span><span class="p">(</span><span class="s1">&#39;JAZA1505&#39;</span><span class="p">)</span>

    <span class="c1"># Obtain sample</span>
    <span class="n">counts</span><span class="p">,</span> <span class="n">info</span> <span class="o">=</span> <span class="n">oo</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span>
        <span class="n">correct_dark_counts</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">correct_nonlinearity</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">integration_time</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>  <span class="c1"># Optimize integration time</span>
        <span class="n">scans_to_average</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>  <span class="c1"># Average of three scans</span>
        <span class="n">boxcar_width</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>  <span class="c1"># Boxcar smoothing</span>
        <span class="n">sample_id</span><span class="o">=</span><span class="s1">&#39;daylight_reflected_off_a_wall&#39;</span>
    <span class="p">)</span>

    <span class="c1"># Visualise</span>
    <span class="n">counts</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;Pixel wavelength&#39;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;Counts&#39;</span><span class="p">)</span>

<span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&gt; Measurement terminated  by user&#39;</span><span class="p">)</span>

<span class="k">finally</span><span class="p">:</span>
    <span class="n">oo</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<br/></pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&gt; Obtaining sample...
&gt; Correcting for dark counts: True
&gt; Correcting for nonlinearity: True
        &gt; Integration time: 0.001 seconds
        &gt; Maximum reported value: 196
        &gt; Integration time: 0.283864 seconds
        &gt; Maximum reported value: 27858
        &gt; Integration time: 0.567596 seconds
        &gt; Maximum reported value: 54664
&gt; Computing average of 3 scans
&gt; Applying boxcar average (boxcar_width = 3)


</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/07a_spectrometer_calibration_5_1.png" src="_images/07a_spectrometer_calibration_5_1.png" />
</div>
</div>
<p>Instead of returning <code class="docutils literal notranslate"><span class="pre">np.array</span></code>, the <code class="docutils literal notranslate"><span class="pre">.sample(...)</span></code> method returns <code class="docutils literal notranslate"><span class="pre">pd.Series</span></code> and a Python dictionary with information about the sample.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">counts</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Wavelength
339.117800    -95.880108
339.496622    -95.880108
339.875414    -95.880108
340.254178    -95.880108
340.632913    -72.797478
                 ...
1027.022982    45.829739
1027.304901    49.134864
1027.586755    49.134864
1027.868542    49.134864
1028.150263    49.134864
Name: Counts, Length: 2048, dtype: float64
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">info</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
{&#39;board_temp&#39;: &#39;NA&#39;,
 &#39;micro_temp&#39;: &#39;NA&#39;,
 &#39;integration_time&#39;: 578402,
 &#39;scans_averaged&#39;: 3,
 &#39;boxcar_width&#39;: 3,
 &#39;max_reported&#39;: 54180.385884315416,
 &#39;upper_bound&#39;: 58981.5,
 &#39;lower_bound&#39;: 52428.0,
 &#39;model&#39;: &#39;JAZ&#39;,
 &#39;serial&#39;: &#39;JAZA1505&#39;,
 &#39;obtained&#39;: &#39;2022-09-17 14:36:57.131657&#39;,
 &#39;sample_id&#39;: &#39;daylight_reflected_off_a_wall&#39;}
</pre></div></div>
</div>
<p>Also, if you don’t specify an integration time, it will be adjusted until the maximum reported value is within 80-90% of pixel resolution, where linearity is best (as above).</p>
<p>Signal-to-noise ratio may also be improved with scan averaging and boxcar smoothing, but be warned! The former increases overall sampling time and the latter comes at the expense of optical resolution and may wash out spectral features if a high value is used. A good rule of thumb is to use low values (e.g., 1-3).</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">try</span><span class="p">:</span>
    <span class="n">fig</span><span class="p">,</span> <span class="p">(</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>

    <span class="n">oo</span> <span class="o">=</span> <span class="n">oceanops</span><span class="o">.</span><span class="n">OceanOptics</span><span class="o">.</span><span class="n">from_serial_number</span><span class="p">(</span><span class="s1">&#39;JAZA1505&#39;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">scans_to_average</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">100</span><span class="p">]):</span>

        <span class="n">counts</span><span class="p">,</span> <span class="n">info</span> <span class="o">=</span> <span class="n">oo</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span>
            <span class="n">correct_dark_counts</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">correct_nonlinearity</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">integration_time</span><span class="o">=</span><span class="mf">1e4</span><span class="p">,</span>
            <span class="n">scans_to_average</span><span class="o">=</span><span class="n">scans_to_average</span>
        <span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">counts</span><span class="o">+</span><span class="p">(</span><span class="n">i</span><span class="o">*</span><span class="mi">1000</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="n">scans_to_average</span><span class="p">)</span>

    <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Multiple scan averaging&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s1">&#39;Scans averaged&#39;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">boxcar_width</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">100</span><span class="p">]):</span>

        <span class="n">counts</span><span class="p">,</span> <span class="n">info</span> <span class="o">=</span> <span class="n">oo</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span>
            <span class="n">correct_dark_counts</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">correct_nonlinearity</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">integration_time</span><span class="o">=</span><span class="mf">1e4</span><span class="p">,</span>
            <span class="n">boxcar_width</span><span class="o">=</span><span class="n">boxcar_width</span>
        <span class="p">)</span>

        <span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">counts</span><span class="o">+</span><span class="p">(</span><span class="n">i</span><span class="o">*</span><span class="mi">1000</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="n">boxcar_width</span><span class="p">)</span>

    <span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Box car smoothing&#39;</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s1">&#39;Box car width&#39;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="p">(</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">):</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Wavelength (nm)&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Counts (offset for clarity)&#39;</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

<span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&gt; Measurement terminated  by user&#39;</span><span class="p">)</span>

<span class="k">finally</span><span class="p">:</span>
    <span class="n">oo</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&gt; Obtaining sample...
&gt; Correcting for dark counts: True
&gt; Correcting for nonlinearity: True
        &gt; Integration time: 0.01 seconds
        &gt; Maximum reported value: 3676


&gt; Obtaining sample...
&gt; Correcting for dark counts: True
&gt; Correcting for nonlinearity: True
        &gt; Integration time: 0.01 seconds
        &gt; Maximum reported value: 3758
&gt; Computing average of 2 scans


&gt; Obtaining sample...
&gt; Correcting for dark counts: True
&gt; Correcting for nonlinearity: True
        &gt; Integration time: 0.01 seconds
        &gt; Maximum reported value: 3684
&gt; Computing average of 5 scans


&gt; Obtaining sample...
&gt; Correcting for dark counts: True
&gt; Correcting for nonlinearity: True
        &gt; Integration time: 0.01 seconds
        &gt; Maximum reported value: 3632
&gt; Computing average of 10 scans


&gt; Obtaining sample...
&gt; Correcting for dark counts: True
&gt; Correcting for nonlinearity: True
        &gt; Integration time: 0.01 seconds
        &gt; Maximum reported value: 3565
&gt; Computing average of 50 scans


&gt; Obtaining sample...
&gt; Correcting for dark counts: True
&gt; Correcting for nonlinearity: True
        &gt; Integration time: 0.01 seconds
        &gt; Maximum reported value: 3583
&gt; Computing average of 100 scans


&gt; Obtaining sample...
&gt; Correcting for dark counts: True
&gt; Correcting for nonlinearity: True
        &gt; Integration time: 0.01 seconds
        &gt; Maximum reported value: 3557


&gt; Obtaining sample...
&gt; Correcting for dark counts: True
&gt; Correcting for nonlinearity: True
        &gt; Integration time: 0.01 seconds
        &gt; Maximum reported value: 3546
&gt; Applying boxcar average (boxcar_width = 1)


&gt; Obtaining sample...
&gt; Correcting for dark counts: True
&gt; Correcting for nonlinearity: True
        &gt; Integration time: 0.01 seconds
        &gt; Maximum reported value: 3537
&gt; Applying boxcar average (boxcar_width = 2)


&gt; Obtaining sample...
&gt; Correcting for dark counts: True
&gt; Correcting for nonlinearity: True
        &gt; Integration time: 0.01 seconds
        &gt; Maximum reported value: 3531
&gt; Applying boxcar average (boxcar_width = 5)


&gt; Obtaining sample...
&gt; Correcting for dark counts: True
&gt; Correcting for nonlinearity: True
        &gt; Integration time: 0.01 seconds
        &gt; Maximum reported value: 3604
&gt; Applying boxcar average (boxcar_width = 10)


&gt; Obtaining sample...
&gt; Correcting for dark counts: True
&gt; Correcting for nonlinearity: True
        &gt; Integration time: 0.01 seconds
        &gt; Maximum reported value: 3545
&gt; Applying boxcar average (boxcar_width = 50)


&gt; Obtaining sample...
&gt; Correcting for dark counts: True
&gt; Correcting for nonlinearity: True
        &gt; Integration time: 0.01 seconds
        &gt; Maximum reported value: 3543
&gt; Applying boxcar average (boxcar_width = 100)


</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/07a_spectrometer_calibration_10_1.png" src="_images/07a_spectrometer_calibration_10_1.png" />
</div>
</div>
<p>I’ve found my seabreeze extension very useful, especially when automating measurements (e.g., when measuring the spectral response of a multiprimary system).</p>
</section>
</section>
<section id="Wavelength-calibration">
<h2>Wavelength calibration<a class="headerlink" href="#Wavelength-calibration" title="Permalink to this heading">¶</a></h2>
<p>The pixels on the spectrometer CCD sensor are aligned to different wavelengths.</p>
<p><a class="reference external" href="https://www.oceaninsight.com/support/faqs/calibration/">According to Ocean Optics</a>, the relationship between pixel and wavelength is described by a third-order polynomial:</p>
<p><span class="math">\begin{equation}
\lambda_p = I + C_1 p + C_2 p^2 + C_3 p^3
\end{equation}</span></p>
<p>Where:</p>
<ul class="simple">
<li><p><span class="math notranslate nohighlight">\(\lambda\)</span> = wavelength of pixel <span class="math notranslate nohighlight">\(p\)</span></p></li>
<li><p><span class="math notranslate nohighlight">\(I\)</span> = wavelength of pixel 0</p></li>
<li><p><span class="math notranslate nohighlight">\(C1\)</span> = first coefficient (nm/pixel)</p></li>
<li><p><span class="math notranslate nohighlight">\(C2\)</span> = second coefficient (nm/pixel<span class="math notranslate nohighlight">\(^2\)</span>)</p></li>
<li><p><span class="math notranslate nohighlight">\(C3\)</span> = third coefficient (nm/pixel<span class="math notranslate nohighlight">\(^3\)</span>)</p></li>
</ul>
<p>The JAZ stores wavelength coefficients from when it was last calibrated, but wavelength calibrations are liable to drift over time due to various factors (e.g., mechanical shock, environmental conditions).</p>
<p>The ground truth for wavelength calibration is dervied from sampling a light source that produces <a class="reference external" href="https://en.wikipedia.org/wiki/Spectral_line">spectral lines</a>, so we borrowed a <a class="reference external" href="http://www.lamptech.co.uk/Spec%20Sheets/D%20SP%20Philips%20LL%20Ar.htm">Philips argon lamp</a> from our local physics department.</p>
<p><img alt="b280d43a8bef4ed9bf7f62b83c701c78" class="no-scaled-link" src="_images/jaz_argon_lamp.png" style="width: 300px;" /></p>
<p>Measurement of the lamp produced a spectrum with lots of lines. I consulted the <a class="reference external" href="https://physics.nist.gov/PhysRefData/ASD/lines_form.html">NIST atomic spectra database</a> to find the known positions of the lines.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>


<span class="c1"># Load sample and spectral lines</span>
<span class="n">ar_spd</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;../../data/jaz/jaz_Ar_spd.csv&#39;</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="s1">&#39;wl&#39;</span><span class="p">)</span>
<span class="n">ar_lines</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;../../data/jaz/NIST_Ar_1_lines_300_1000.csv&#39;</span><span class="p">)</span>

<span class="c1"># Plot spd and line positions</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
<span class="n">ar_spd</span><span class="o">.</span><span class="n">pwr</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Argon lamp SPD&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">vlines</span><span class="p">(</span><span class="n">ar_lines</span><span class="p">[</span><span class="s1">&#39;wl&#39;</span><span class="p">],</span> <span class="o">-</span><span class="mi">3500</span><span class="p">,</span> <span class="o">-</span><span class="mi">1750</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;purple&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Ar I line positions&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;Pixel wavelength (nm)&#39;</span><span class="p">,</span>
       <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;Counts&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">();</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/07a_spectrometer_calibration_14_0.png" src="_images/07a_spectrometer_calibration_14_0.png" />
</div>
</div>
<p>Many of the lines were not resolved by the spectrometer, presumably due to undersaturation or pixel resolution limitations, but most tallied up with visible peaks. I used a peak-finding algorithm to try and find the corresponding peaks in the spectrum, based on certain criteria.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">signal</span>

<span class="c1"># Find peaks</span>
<span class="n">peak_idxs</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">find_peaks</span><span class="p">(</span>
    <span class="n">ar_spd</span><span class="p">[</span><span class="s1">&#39;pwr&#39;</span><span class="p">],</span>
    <span class="n">height</span><span class="o">=</span><span class="mi">1800</span><span class="p">,</span>
    <span class="n">prominence</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span>
    <span class="n">threshold</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span>
    <span class="n">distance</span><span class="o">=</span><span class="mi">10</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">peaks</span> <span class="o">=</span> <span class="n">ar_spd</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ar_spd</span><span class="o">.</span><span class="n">pxl</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">peak_idxs</span><span class="p">)]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">vlines</span><span class="p">(</span><span class="n">peaks</span><span class="p">[</span><span class="s1">&#39;wl&#39;</span><span class="p">],</span> <span class="o">-</span><span class="mi">1750</span><span class="p">,</span> <span class="n">peaks</span><span class="p">[</span><span class="s1">&#39;pwr&#39;</span><span class="p">],</span> <span class="n">lw</span><span class="o">=</span><span class="mf">.5</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">((</span><span class="mi">380</span><span class="p">,</span> <span class="mi">780</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">((</span><span class="o">-</span><span class="mi">3000</span><span class="p">,</span> <span class="mi">30000</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">fig</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="output_area docutils container">
<img alt="_images/07a_spectrometer_calibration_16_0.png" src="_images/07a_spectrometer_calibration_16_0.png" />
</div>
</div>
<p>This showed a general pattern of rightward drift of about 1 nm, but the line pairing was not obvious so I zoomed in on a pdf plot and manually paired the detected peaks with the nearest line to the left, if there was one, dropping it otherwise. This led to 44 lines accross the full range of reported wavelengths.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><br/><span></span><span class="c1"># True line positions for selected peaks</span>
<span class="n">true_wls</span> <span class="o">=</span> <span class="p">[</span>
    <span class="mf">394.8979</span><span class="p">,</span> <span class="mf">404.4418</span><span class="p">,</span> <span class="mf">415.859</span><span class="p">,</span> <span class="mf">419.8317</span><span class="p">,</span> <span class="mf">426.6286</span><span class="p">,</span> <span class="mf">433.3561</span><span class="p">,</span>
    <span class="mf">451.0733</span><span class="p">,</span> <span class="mf">459.6097</span><span class="p">,</span> <span class="mf">470.2316</span><span class="p">,</span> <span class="mf">518.7746</span><span class="p">,</span> <span class="mf">522.1271</span><span class="p">,</span> <span class="mf">545.1652</span><span class="p">,</span>
    <span class="mf">549.5874</span><span class="p">,</span> <span class="mf">560.6733</span><span class="p">,</span> <span class="mf">565.0704</span><span class="p">,</span> <span class="mf">573.952</span><span class="p">,</span> <span class="mf">583.4263</span><span class="p">,</span> <span class="mf">588.8584</span><span class="p">,</span>
    <span class="mf">599.8999</span><span class="p">,</span> <span class="mf">603.2127</span><span class="p">,</span> <span class="mf">610.5635</span><span class="p">,</span> <span class="mf">617.3096</span><span class="p">,</span> <span class="mf">621.5938</span><span class="p">,</span> <span class="mf">630.7657</span><span class="p">,</span>
    <span class="mf">641.6307</span><span class="p">,</span> <span class="mf">653.8112</span><span class="p">,</span> <span class="mf">660.4853</span><span class="p">,</span> <span class="mf">667.7282</span><span class="p">,</span> <span class="mf">675.2834</span><span class="p">,</span> <span class="mf">687.1289</span><span class="p">,</span>
    <span class="mf">693.7664</span><span class="p">,</span> <span class="mf">703.0251</span><span class="p">,</span> <span class="mf">714.7042</span><span class="p">,</span> <span class="mf">720.698</span><span class="p">,</span> <span class="mf">731.1716</span><span class="p">,</span> <span class="mf">735.3293</span><span class="p">,</span>
    <span class="mf">743.6297</span><span class="p">,</span> <span class="mf">789.1075</span><span class="p">,</span> <span class="mf">860.5776</span><span class="p">,</span> <span class="mf">866.7944</span><span class="p">,</span> <span class="mf">919.4638</span><span class="p">,</span> <span class="mf">935.422</span><span class="p">,</span>
    <span class="mf">965.7786</span><span class="p">,</span> <span class="mf">978.4503</span>
<span class="p">]</span>

<span class="c1"># Remove suspect peaks without a true-line companion</span>
<span class="n">drop_px</span> <span class="o">=</span> <span class="p">[</span><span class="mi">448</span><span class="p">,</span> <span class="mi">648</span><span class="p">,</span> <span class="mi">947</span><span class="p">]</span>
<span class="n">peaks</span> <span class="o">=</span> <span class="n">peaks</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="o">~</span><span class="n">peaks</span><span class="o">.</span><span class="n">pxl</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">drop_px</span><span class="p">)]</span>
<span class="n">peaks</span><span class="p">[</span><span class="s1">&#39;true_wl&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">true_wls</span>
<br/></pre></div>
</div>
</div>
<p>Now, to calculate the wavelength coefficients and predict the new values.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Third order polynomial</span>
<span class="n">poly</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polyfit</span><span class="p">(</span><span class="n">peaks</span><span class="p">[</span><span class="s1">&#39;pxl&#39;</span><span class="p">],</span> <span class="n">peaks</span><span class="p">[</span><span class="s1">&#39;true_wl&#39;</span><span class="p">],</span> <span class="n">deg</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&gt; The wavelength coefficients are:</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="o">*</span><span class="n">poly</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">calibrated_wls</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polyval</span><span class="p">(</span><span class="n">poly</span><span class="p">,</span> <span class="n">ar_spd</span><span class="o">.</span><span class="n">pxl</span><span class="p">)</span>
<br/></pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&gt; The wavelength coefficients are:

338.5374924539017
0.3802367113739599
-1.5959354792685768e-05
-2.507246200675931e-09
</pre></div></div>
</div>
<p>These coefficients can be updated in the spectrometer using Ocean Optics software, or the new wavelengths can be applied at a later stage of processing.</p>
<p>Here’s the visible portion of the original spectrum plotted against the old and new wavelengths. Note that the true lines match better with the peaks when they are plotted against the calibrated wavelengths.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>

<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ar_spd</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">ar_spd</span><span class="o">.</span><span class="n">pwr</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Old Wavelengths&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">calibrated_wls</span><span class="p">,</span> <span class="n">ar_spd</span><span class="o">.</span><span class="n">pwr</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Calibrated Wavelengths&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">vlines</span><span class="p">(</span><span class="n">true_wls</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">60000</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;purple&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">.4</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Ar I line positions&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">xlim</span><span class="o">=</span><span class="p">(</span><span class="mi">380</span><span class="p">,</span> <span class="mi">780</span><span class="p">),</span>
       <span class="n">ylim</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">30000</span><span class="p">),</span>
       <span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;Wavelength (nm)&#39;</span><span class="p">,</span>
      <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;Counts&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/07a_spectrometer_calibration_22_0.png" src="_images/07a_spectrometer_calibration_22_0.png" />
</div>
</div>
<p>In the end it was a lot of effort for a small correction, but worth it!</p>
</section>
<section id="Absolute-irradiance-calibration">
<h2>Absolute irradiance calibration<a class="headerlink" href="#Absolute-irradiance-calibration" title="Permalink to this heading">¶</a></h2>
<p>Absolute irradiance calibration allows for measurements to be reported in energy units, such as <span class="math notranslate nohighlight">\(\mu W/cm^2/nm\)</span>, which can be preferable to <em>counts</em>-based measures. This is achieved by taking a reference measurement of a radiometrically calibrated light source with known power output and then working out, for each pixel, how many microjoules a count represents (i.e., <span class="math notranslate nohighlight">\(\mu J/count\)</span> ratio).</p>
<p><a class="reference external" href="https://www.oceaninsight.com/support/faqs/calibration/">According to Ocean Optics</a>, with the <span class="math notranslate nohighlight">\(\mu J/count\)</span> ratio for each pixel, one can convert to energy units using this forumla:</p>
<p><span class="math">\begin{equation}
I_p = (S_p - D_p) * C_p / (T * A * dL_p)
\end{equation}</span></p>
<p>Where:</p>
<ul class="simple">
<li><p><span class="math notranslate nohighlight">\(C_p\)</span> = calibration file, in <span class="math notranslate nohighlight">\(\mu J/count\)</span> (specific to the sampling optic)</p></li>
<li><p><span class="math notranslate nohighlight">\(S_p\)</span> = sample spectrum in count units</p></li>
<li><p><span class="math notranslate nohighlight">\(D_p\)</span> = dark spectrum in count units (i.e., the electrical noise floor)</p></li>
<li><p><span class="math notranslate nohighlight">\(T\)</span> = integration time in seconds</p></li>
<li><p><span class="math notranslate nohighlight">\(A\)</span> = collection area in cm<span class="math notranslate nohighlight">\(^2\)</span></p></li>
<li><p><span class="math notranslate nohighlight">\(dL_p\)</span> = wavelength spread (how many nanometers each pixel represents)</p></li>
</ul>
<p>Our NIST-traceable HL-2000-CAL light source is suitable for absolute irradiance calculation. It has a tungsten-halogen bulb with a color temperature of 3100 kelvin, and it came with calibration files expressing its known power output at certain wavelengths in <span class="math notranslate nohighlight">\(\mu W/cm^2/nm\)</span>, when measured with either a fibre optic probe or cosine corrector (the sampling optic affects the measured power).</p>
<p>It is relatively easy to perform an absolute irradiance calibration with the <a class="reference external" href="https://www.oceaninsight.com/products/software/acquisition-and-analysis/oceanview/">Ocean View software</a>, which is available for a 30-day free trial.</p>
<p>Turn the light source on and wait for it to reach thermal equilibrium (~15 mins) and then select the <em>Absolute Irradiance Calibration</em> option. The software guides you through the process of taking a reference measurement, a dark measurement to compensate for electrical noise in the CCD, uploading the relevant lamp calibration file, and obtaining the <span class="math notranslate nohighlight">\(\mu J/count\)</span> pixel calibration file.</p>
<p><img alt="caf98231987c4211a9ac331098da5dea" class="no-scaled-link" src="_images/jaz_hl_2000_cal.png" style="width: 400px;" /></p>
<p>The calibration output looks like this.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="c1"># Load the HL-2000-CAL lamp calibration data for fibre optic probe</span>
<span class="n">lamp_file</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_table</span><span class="p">(</span><span class="s1">&#39;../../data/jaz/030410313_FIB.LMP&#39;</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
<span class="n">lamp_file</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Wavelength&#39;</span><span class="p">,</span> <span class="s1">&#39;uJ/cm2&#39;</span><span class="p">]</span>
<span class="n">lamp_file</span> <span class="o">=</span> <span class="n">lamp_file</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>

<span class="c1"># Load the Ocean View calibration output</span>
<span class="n">ocean_view_cal</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_table</span><span class="p">(</span><span class="s1">&#39;../../data/jaz/JAZ_OOIIrrad.cal&#39;</span><span class="p">,</span> <span class="n">skiprows</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
<span class="n">lamp_preview</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_table</span><span class="p">(</span><span class="s1">&#39;../../data/jaz/JAZ_LampIntensityPreview.txt&#39;</span><span class="p">,</span> <span class="n">skiprows</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
<span class="n">lamp_preview</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">lamp_preview</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
<span class="n">lamp_preview</span> <span class="o">=</span> <span class="n">lamp_preview</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;Wavelength&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>

<span class="c1"># Visualise</span>
<span class="n">fig</span><span class="p">,</span> <span class="p">(</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
<span class="n">ocean_view_cal</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;$\mu J$/count&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;OceanView calibration file&#39;</span><span class="p">)</span>
<span class="n">lamp_file</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax2</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;Wavelength&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;uJ/cm2&#39;</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;scatter&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;HL-2000-CAL&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Known output of light source&#39;</span><span class="p">)</span>
<span class="n">lamp_preview</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax2</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;gold&#39;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;$\mu W$/cm$^2$/nm&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Calibrated sample (OceanView)&#39;</span><span class="p">);</span>

<span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="p">[</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">]:</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;Pixel wavelength (nm)&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<br/></pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/07a_spectrometer_calibration_26_0.png" src="_images/07a_spectrometer_calibration_26_0.png" />
</div>
</div>
<p>Here’s how to perform the irradiance calibration without using OceanView.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">interpolate</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="kn">from</span> <span class="nn">pyplr.oceanops</span> <span class="kn">import</span> <span class="n">OceanOptics</span>


<span class="k">try</span><span class="p">:</span>
    <span class="c1"># Connect to JAZ</span>
    <span class="n">oo</span> <span class="o">=</span> <span class="n">OceanOptics</span><span class="o">.</span><span class="n">from_serial_number</span><span class="p">(</span><span class="s1">&#39;JAZA1505&#39;</span><span class="p">)</span>

    <span class="c1"># Perform reference measurement</span>
    <span class="nb">input</span><span class="p">(</span><span class="s1">&#39;Hit enter to obtain reference measurement:&#39;</span><span class="p">)</span>
    <span class="n">reference_counts</span><span class="p">,</span> <span class="n">reference_info</span> <span class="o">=</span> <span class="n">oo</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span>
        <span class="n">correct_nonlinearity</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">correct_dark_counts</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">scans_to_average</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
        <span class="n">boxcar_width</span><span class="o">=</span><span class="mi">2</span>
    <span class="p">)</span>
    <span class="n">reference_counts</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Reference&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="c1"># Perform dark measurement</span>
    <span class="nb">input</span><span class="p">(</span><span class="s1">&#39;Now block all light and hit enter to obtain dark counts:&#39;</span><span class="p">)</span>
    <span class="n">dark_counts</span><span class="p">,</span> <span class="n">dark_info</span> <span class="o">=</span> <span class="n">oo</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span>
        <span class="n">correct_nonlinearity</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">correct_dark_counts</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">integration_time</span> <span class="o">=</span> <span class="n">reference_info</span><span class="p">[</span><span class="s1">&#39;integration_time&#39;</span><span class="p">],</span>
        <span class="n">scans_to_average</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
        <span class="n">boxcar_width</span><span class="o">=</span><span class="mi">2</span>
    <span class="p">)</span>
    <span class="n">dark_counts</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Dark counts&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="c1"># Resample lamp file to pixel wavelengths</span>
    <span class="n">interp_func</span> <span class="o">=</span> <span class="n">interpolate</span><span class="o">.</span><span class="n">interp1d</span><span class="p">(</span><span class="n">lamp_file</span><span class="p">[</span><span class="s1">&#39;Wavelength&#39;</span><span class="p">],</span> <span class="n">lamp_file</span><span class="p">[</span><span class="s1">&#39;uJ/cm2&#39;</span><span class="p">])</span>
    <span class="n">wavelengths</span> <span class="o">=</span> <span class="n">reference_counts</span><span class="o">.</span><span class="n">index</span>
    <span class="n">resampled_lamp_data</span> <span class="o">=</span> <span class="n">interp_func</span><span class="p">(</span><span class="n">wavelengths</span><span class="p">)</span>

    <span class="c1"># Calculate scaling parameters</span>
    <span class="n">integration_time</span> <span class="o">=</span> <span class="n">reference_info</span><span class="p">[</span><span class="s1">&#39;integration_time&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="mf">1e6</span>  <span class="c1"># Microseconds to seconds</span>
    <span class="n">fibre_diameter</span> <span class="o">=</span> <span class="mi">400</span> <span class="o">/</span> <span class="mf">1e4</span>  <span class="c1"># Microns to cm</span>
    <span class="n">collection_area</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="p">(</span><span class="n">fibre_diameter</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>  <span class="c1"># cm2</span>
    <span class="n">wavelength_spread</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">(</span>  <span class="c1"># How many nanometers each pixel represents</span>
        <span class="p">[(</span><span class="n">wavelengths</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">wavelengths</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
         <span class="p">(</span><span class="n">wavelengths</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span> <span class="o">-</span> <span class="n">wavelengths</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
         <span class="p">(</span><span class="n">wavelengths</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">wavelengths</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span>
        <span class="p">]</span>
    <span class="p">)</span>

    <span class="c1"># Make the calibration file. To do this we need to adapt the</span>
    <span class="c1"># formula slightly, dividing the resampled lamp data by the</span>
    <span class="c1"># reference measurement (instead of multiplying the reference</span>
    <span class="c1"># measurement by the calibration file).</span>
    <span class="n">calibration_file</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">resampled_lamp_data</span>
        <span class="o">/</span> <span class="p">((</span><span class="n">reference_counts</span> <span class="o">-</span> <span class="n">dark_counts</span><span class="p">)</span>
           <span class="o">/</span> <span class="p">(</span><span class="n">integration_time</span>
              <span class="o">*</span> <span class="n">collection_area</span>
              <span class="o">*</span> <span class="n">wavelength_spread</span><span class="p">)</span>
          <span class="p">)</span>
    <span class="p">)</span>

<span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&gt; Calibration terminated by user&#39;</span><span class="p">)</span>

<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&gt; Something else went wrong&#39;</span><span class="p">)</span>
    <span class="k">raise</span> <span class="n">e</span>

<span class="k">finally</span><span class="p">:</span>
    <span class="n">oo</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&gt; Closing connection to spectrometer&#39;</span><span class="p">)</span>
<br/><br/></pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Hit enter to obtain reference measurement:
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&gt; Obtaining sample...
&gt; Correcting for dark counts: False
&gt; Correcting for nonlinearity: True
        &gt; Integration time: 0.001 seconds
        &gt; Maximum reported value: 7205
        &gt; Integration time: 0.00773 seconds
        &gt; Maximum reported value: 43571
        &gt; Integration time: 0.009883 seconds
        &gt; Maximum reported value: 55026
&gt; Computing average of 3 scans
&gt; Applying boxcar average (boxcar_width = 2)


</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/07a_spectrometer_calibration_28_2.png" src="_images/07a_spectrometer_calibration_28_2.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Now block all light and hit enter to obtain dark counts:
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&gt; Obtaining sample...
&gt; Correcting for dark counts: False
&gt; Correcting for nonlinearity: True
        &gt; Integration time: 0.010005 seconds
        &gt; Maximum reported value: 1720
&gt; Computing average of 3 scans
&gt; Applying boxcar average (boxcar_width = 2)


</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/07a_spectrometer_calibration_28_5.png" src="_images/07a_spectrometer_calibration_28_5.png" />
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&gt; Closing connection to spectrometer
</pre></div></div>
</div>
<p>Let’s compare the new calibration with the one from Ocean View and focus on the visible wavelengths.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">mpl_toolkits.axes_grid1.inset_locator</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">mark_inset</span><span class="p">,</span>
    <span class="n">inset_axes</span>
<span class="p">)</span>


<span class="n">fig</span><span class="p">,</span> <span class="p">(</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>

<span class="c1"># Plot OceanView calibration</span>
<span class="n">ocean_view_cal</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax1</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;OceanView calibration&#39;</span><span class="p">,</span> <span class="n">legend</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">axins1</span> <span class="o">=</span> <span class="n">inset_axes</span><span class="p">(</span><span class="n">ax1</span><span class="p">,</span> <span class="s1">&#39;40%&#39;</span><span class="p">,</span> <span class="s1">&#39;40%&#39;</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;lower center&#39;</span><span class="p">)</span>
<span class="n">ocean_view_cal</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">axins1</span><span class="p">,</span> <span class="n">legend</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="c1"># Plot this calibration</span>
<span class="n">calibration_file</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax2</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;This calibration&#39;</span><span class="p">)</span>
<span class="n">axins2</span> <span class="o">=</span> <span class="n">inset_axes</span><span class="p">(</span><span class="n">ax2</span><span class="p">,</span> <span class="s1">&#39;40%&#39;</span><span class="p">,</span> <span class="s1">&#39;40%&#39;</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;lower center&#39;</span><span class="p">)</span>
<span class="n">calibration_file</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">axins2</span><span class="p">,</span> <span class="n">legend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>

<span class="k">for</span> <span class="n">axins</span> <span class="ow">in</span> <span class="p">[</span><span class="n">axins1</span><span class="p">,</span> <span class="n">axins2</span><span class="p">]:</span>
    <span class="n">axins</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">380</span><span class="p">,</span> <span class="mi">780</span><span class="p">)</span>
    <span class="n">axins</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="o">-</span><span class="mf">.002e-8</span><span class="p">,</span> <span class="mf">.02e-8</span><span class="p">)</span>
    <span class="n">axins</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([])</span>
    <span class="n">axins</span><span class="o">.</span><span class="n">minorticks_on</span><span class="p">()</span>
    <span class="n">axins</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">which</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">bottom</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">axins</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;both&#39;</span><span class="p">)</span>


<span class="k">for</span> <span class="n">ax</span><span class="p">,</span> <span class="n">axins</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">([</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">],</span> <span class="p">[</span><span class="n">axins1</span><span class="p">,</span> <span class="n">axins2</span><span class="p">]):</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">((</span><span class="o">-</span><span class="mf">2.5e-8</span><span class="p">,</span> <span class="mf">1.5e-8</span><span class="p">))</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;$\mu$J/count&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Pixel wavelength&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">indicate_inset_zoom</span><span class="p">(</span>
        <span class="n">axins</span><span class="p">,</span>
        <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span>
        <span class="n">transform</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">get_xaxis_transform</span><span class="p">()</span>
    <span class="p">)</span>
<br/></pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/07a_spectrometer_calibration_30_0.png" src="_images/07a_spectrometer_calibration_30_0.png" />
</div>
</div>
<p>The insets show, according to each calibration file, the <span class="math notranslate nohighlight">\(\mu J/count\)</span> ratio for all pixels that represent visible wavelengths. It’s the same shape! The slight difference in magnitude could be related to adjustments to the sampling optic between calibrations (i.e., I swapped the fiber at one point to calibrate with the long fiber optic cable). Also, the set screw on the light source was jammed for a while, which stopped the probe being inserted to maximum depth.</p>
<p>The final test… apply the original formula to the reference measurement using each calibration file.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># This calibration</span>
<span class="n">this_calibration_spectrum</span> <span class="o">=</span> <span class="p">(</span>
    <span class="p">(</span><span class="n">reference_counts</span> <span class="o">-</span> <span class="n">dark_counts</span><span class="p">)</span>
    <span class="o">*</span> <span class="p">(</span><span class="n">calibration_file</span>  <span class="c1"># The calibration file we just made</span>
       <span class="o">/</span> <span class="p">(</span><span class="n">integration_time</span>
          <span class="o">*</span> <span class="n">collection_area</span>
          <span class="o">*</span> <span class="n">wavelength_spread</span><span class="p">)</span>
      <span class="p">)</span>
<span class="p">)</span>

<span class="c1"># Ocean View calibration</span>
<span class="n">ov_calibration_spectrum</span> <span class="o">=</span> <span class="p">(</span>
    <span class="p">(</span><span class="n">reference_counts</span> <span class="o">-</span> <span class="n">dark_counts</span><span class="p">)</span>
    <span class="o">*</span> <span class="p">(</span><span class="n">ocean_view_cal</span><span class="o">.</span><span class="n">values</span>  <span class="c1"># The OceanView calibration</span>
       <span class="o">/</span> <span class="p">(</span><span class="n">integration_time</span>
          <span class="o">*</span> <span class="n">collection_area</span>
          <span class="o">*</span> <span class="n">wavelength_spread</span><span class="p">)</span>
      <span class="p">)</span>
<span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="p">(</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>

<span class="n">reference_counts</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax1</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Reference spectrum</span><span class="se">\n</span><span class="s1">(HL-2000-CAL)&#39;</span><span class="p">)</span>

<span class="n">ov_calibration_spectrum</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax2</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;OceanView calibration&#39;</span><span class="p">)</span>
<span class="n">this_calibration_spectrum</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax2</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;This calibration&#39;</span><span class="p">)</span>
<span class="n">lamp_file</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax2</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;Wavelength&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;uJ/cm2&#39;</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;scatter&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Known output of HL-2000-CAL&#39;</span><span class="p">)</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Counts&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;$\mu W$/cm$^2$/nm&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Calibrated reference spectrum</span><span class="se">\n</span><span class="s1">(HL-2000-CAL)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="p">[</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">]:</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Wavelength (nm)&#39;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/07a_spectrometer_calibration_32_0.png" src="_images/07a_spectrometer_calibration_32_0.png" />
</div>
</div>
<p>This procedure can be performed immediately before collecting samples. I have updated <code class="docutils literal notranslate"><span class="pre">pyplr.oceanops.OceanOptics</span></code> so that it can run the irradiance calibration procedure.</p>
</section>
<section id="Putting-it-all-together">
<h2>Putting it all together<a class="headerlink" href="#Putting-it-all-together" title="Permalink to this heading">¶</a></h2>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[66]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">try</span><span class="p">:</span>
    <span class="c1"># Connect to spectrometer</span>
    <span class="n">oo</span> <span class="o">=</span> <span class="n">oceanops</span><span class="o">.</span><span class="n">OceanOptics</span><span class="o">.</span><span class="n">from_serial_number</span><span class="p">(</span><span class="s1">&#39;JAZA1505&#39;</span><span class="p">)</span>

    <span class="c1"># Obtain sample</span>
    <span class="n">counts</span><span class="p">,</span> <span class="n">info</span> <span class="o">=</span> <span class="n">oo</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span>
        <span class="n">correct_dark_counts</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">correct_nonlinearity</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">integration_time</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>  <span class="c1"># Optimize integration time</span>
        <span class="n">scans_to_average</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>  <span class="c1"># Average of three scans</span>
        <span class="n">boxcar_width</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>  <span class="c1"># Boxcar smoothing</span>
        <span class="n">sample_id</span><span class="o">=</span><span class="s1">&#39;daylight_spectrum&#39;</span>
    <span class="p">)</span>

    <span class="c1"># Absolute spectral irradiance</span>
    <span class="n">irrad_spd</span> <span class="o">=</span> <span class="p">(</span>
        <span class="p">(</span><span class="n">counts</span><span class="p">)</span>  <span class="c1"># Already corrected for dark counts</span>
        <span class="o">*</span> <span class="p">(</span><span class="n">calibration_file</span>
           <span class="o">/</span> <span class="p">(</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;integration_time&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="mf">1e6</span>
              <span class="o">*</span> <span class="n">collection_area</span>
              <span class="o">*</span> <span class="n">wavelength_spread</span><span class="p">)</span>
          <span class="p">)</span>
    <span class="p">)</span>

    <span class="c1"># Visualise</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">calibrated_wls</span><span class="p">,</span> <span class="n">counts</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;orange&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Counts&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Counts&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">set_color</span><span class="p">(</span><span class="s1">&#39;orange&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">colors</span><span class="o">=</span><span class="s1">&#39;orange&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Daylight spectrum&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Wavelength (nm)&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">65553</span><span class="p">))</span>

    <span class="n">twinx</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">twinx</span><span class="p">()</span>
    <span class="n">twinx</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">calibrated_wls</span><span class="p">,</span> <span class="n">irrad_spd</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;darkblue&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Irradiance&#39;</span><span class="p">)</span>
    <span class="n">twinx</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Absolute spectral irradiance</span><span class="se">\n</span><span class="s1"> ($\mu$W/cm$^2$/nm)&#39;</span><span class="p">)</span>
    <span class="n">twinx</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mf">.4</span><span class="p">))</span>
    <span class="n">twinx</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">set_color</span><span class="p">(</span><span class="s1">&#39;darkblue&#39;</span><span class="p">)</span>
    <span class="n">twinx</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">colors</span><span class="o">=</span><span class="s1">&#39;darkblue&#39;</span><span class="p">)</span>

<span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&gt; Measurement terminated  by user&#39;</span><span class="p">)</span>

<span class="k">finally</span><span class="p">:</span>
    <span class="n">oo</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&gt; Obtaining sample...
&gt; Correcting for dark counts: True
&gt; Correcting for nonlinearity: True
        &gt; Integration time: 0.001 seconds
        &gt; Maximum reported value: 6529
        &gt; Integration time: 0.00853 seconds
        &gt; Maximum reported value: 54151
&gt; Computing average of 3 scans
&gt; Applying boxcar average (boxcar_width = 3)


</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/07a_spectrometer_calibration_35_1.png" src="_images/07a_spectrometer_calibration_35_1.png" />
</div>
</div>
</section>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="index.html">
              <img class="logo" src="_static/photoreceptor_characters.png" alt="Logo"/>
            </a></p>
<h1 class="logo"><a href="index.html">PySilSub</a></h1>



<p class="blurb">A Python software for performing the method of silent substitution.</p>




<p>
<iframe src="https://ghbtns.com/github-btn.html?user=PySilentSubstitution&repo=pysilsub&type=watch&count=true&size=large&v=2"
  allowtransparency="true" frameborder="0" scrolling="0" width="200px" height="35px"></iframe>
</p>





<h3>Navigation</h3>
<p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="01_background.html">Background</a></li>
<li class="toctree-l1"><a class="reference internal" href="02_installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="03_overview.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="05_examples.html">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="06_api.html">API Documentation</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="07_project_notes.html">Project notes</a><ul class="current">
<li class="toctree-l2 current"><a class="current reference internal" href="#">Spectrometer</a></li>
<li class="toctree-l2"><a class="reference internal" href="07b_individual_differences.html">Individual differences</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="10_funding.html">Funding</a></li>
<li class="toctree-l1"><a class="reference internal" href="11_citation.html">Citation</a></li>
</ul>


<hr />
<ul>
    
    <li class="toctree-l1"><a href="https://pypi.org/project/pysilsub/">PyPi</a></li>
    
</ul>
<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="index.html">Documentation overview</a><ul>
  <li><a href="07_project_notes.html">Project notes</a><ul>
      <li>Previous: <a href="07_project_notes.html" title="previous chapter">Project notes</a></li>
      <li>Next: <a href="07b_individual_differences.html" title="next chapter">Individual differences</a></li>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2022, Joel T. Martin.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 5.0.2</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="_sources/07a_spectrometer_calibration.ipynb.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>