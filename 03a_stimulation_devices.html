
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Stimulation devices &#8212; PySilSub 0.0.1 documentation</title>
    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="_static/alabaster.css" />
    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Making stimuli" href="03b_making_stimuli.html" />
    <link rel="prev" title="Overview" href="03_overview.html" />
   
  <link rel="stylesheet" href="_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput.container div.prompt *,
div.nboutput.container div.prompt *,
div.nbinput.container div.input_area pre,
div.nboutput.container div.output_area pre,
div.nbinput.container div.input_area .highlight,
div.nboutput.container div.output_area .highlight {
    border: none;
    padding: 0;
    margin: 0;
    box-shadow: none;
}

div.nbinput.container > div[class*=highlight],
div.nboutput.container > div[class*=highlight] {
    margin: 0;
}

div.nbinput.container div.prompt *,
div.nboutput.container div.prompt * {
    background: none;
}

div.nboutput.container div.output_area .highlight,
div.nboutput.container div.output_area pre {
    background: unset;
}

div.nboutput.container div.output_area div.highlight {
    color: unset;  /* override Pygments text color */
}

/* avoid gaps between output lines */
div.nboutput.container div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput.container,
div.nboutput.container {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput.container,
    div.nboutput.container {
        flex-direction: column;
    }
}

/* input container */
div.nbinput.container {
    padding-top: 5px;
}

/* last container */
div.nblast.container {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput.container div.prompt pre {
    color: #307FC1;
}

/* output prompt */
div.nboutput.container div.prompt pre {
    color: #BF5B3D;
}

/* all prompts */
div.nbinput.container div.prompt,
div.nboutput.container div.prompt {
    width: 4.5ex;
    padding-top: 5px;
    position: relative;
    user-select: none;
}

div.nbinput.container div.prompt > div,
div.nboutput.container div.prompt > div {
    position: absolute;
    right: 0;
    margin-right: 0.3ex;
}

@media (max-width: 540px) {
    div.nbinput.container div.prompt,
    div.nboutput.container div.prompt {
        width: unset;
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput.container div.prompt.empty {
        padding: 0;
    }

    div.nbinput.container div.prompt > div,
    div.nboutput.container div.prompt > div {
        position: unset;
    }
}

/* disable scrollbars on prompts */
div.nbinput.container div.prompt pre,
div.nboutput.container div.prompt pre {
    overflow: hidden;
}

/* input/output area */
div.nbinput.container div.input_area,
div.nboutput.container div.output_area {
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput.container div.input_area,
    div.nboutput.container div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput.container div.input_area {
    border: 1px solid #e0e0e0;
    border-radius: 2px;
    /*background: #f5f5f5;*/
}

/* override MathJax center alignment in output cells */
div.nboutput.container div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.imgmath center alignment in output cells */
div.nboutput.container div.math p {
    text-align: left;
}

/* standard error */
div.nboutput.container div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-default-inverse-fg { color: #FFFFFF; }
.ansi-default-inverse-bg { background-color: #000000; }

.ansi-bold { font-weight: bold; }
.ansi-underline { text-decoration: underline; }


div.nbinput.container div.input_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight].math,
div.nboutput.container div.output_area.rendered_html,
div.nboutput.container div.output_area > div.output_javascript,
div.nboutput.container div.output_area:not(.rendered_html) > img{
    padding: 5px;
    margin: 0;
}

/* fix copybtn overflow problem in chromium (needed for 'sphinx_copybutton') */
div.nbinput.container div.input_area > div[class^='highlight'],
div.nboutput.container div.output_area > div[class^='highlight']{
    overflow-y: hidden;
}

/* hide copybtn icon on prompts (needed for 'sphinx_copybutton') */
.prompt .copybtn {
    display: none;
}

/* Some additional styling taken form the Jupyter notebook CSS */
div.rendered_html table {
  border: none;
  border-collapse: collapse;
  border-spacing: 0;
  color: black;
  font-size: 12px;
  table-layout: fixed;
}
div.rendered_html thead {
  border-bottom: 1px solid black;
  vertical-align: bottom;
}
div.rendered_html tr,
div.rendered_html th,
div.rendered_html td {
  text-align: right;
  vertical-align: middle;
  padding: 0.5em 0.5em;
  line-height: normal;
  white-space: normal;
  max-width: none;
  border: none;
}
div.rendered_html th {
  font-weight: bold;
}
div.rendered_html tbody tr:nth-child(odd) {
  background: #f5f5f5;
}
div.rendered_html tbody tr:hover {
  background: rgba(66, 165, 245, 0.2);
}
</style>
<section id="Stimulation-devices">
<h1>Stimulation devices<a class="headerlink" href="#Stimulation-devices" title="Permalink to this headline">¶</a></h1>
<p>To stimulate one class of retinal photoreceptor without changing the activation in others—which is to perform the method of silent substitution—requires a multiprimary stimulation device with at least as many primaries as there are photoreceptors in the retina. This generally means that <a class="reference internal" href="01_background.html"><span class="doc">5 primaries are needed</span></a>, although 4 primaries may suffice when working in the photopic range as rod photoreceptors become saturated and incapable of signalling above 300 cd/m<span class="math notranslate nohighlight">\(^2\)</span>
(<a class="reference external" href="https://doi.org/10.1080/713818657">Aguiller and Stiles, 1954</a>; <a class="reference external" href="https://doi.org/10.1016/0042-6989(82)90143-2">Adelson, 1982</a>; but see <a class="reference external" href="https://iovs.arvojournals.org/article.aspx?articleid=2200107">Shapiro, 2002</a>; <a class="reference external" href="https://doi.org/10.1007/s10633-008-9159-0">Kremers et al., 2009</a>). The primaries should be independantly addressable, additive, and ideally stable over time with a linear gamma function. Peak wavelength and bandwidth are key considerations that will ultimately define the
gamut and available contrast (<a class="reference external" href="https://doi.org/10.1364/josaa.420373">Evéquoz et al., 2021</a>), and the light source will also need to be integrated into an optical setup for stimulus delivery—usually either a Ganzfeld (e.g., <a class="reference external" href="https://doi.org/10.3758/s13428-021-01759-3">Martin et al., 2021</a>) or Maxwellian (e.g., <a class="reference external" href="https://doi.org/10.1167/15.1.27">Cao et al., 2015</a>).</p>
<p><a class="reference external" href="https://doi.org/10.3390/photonics7040121">Conus and Geiser (2020)</a> reviewed stimulation devices from a range of silent substitution studies and found that in most cases the device had 4 or 5 primaries and was built from scratch using LEDs, optical bench components, and microprocessors, such as Arduino, for pulse width modulation control of intensity. Only a few devices were commercially bought. Whatever the device and setup, it will be necessary to have a forward calibration model that is
representative of what an observer sees, and which can be used to predict spectral output for any combination of settings. Typically this involves sampling each of the primaries at a range of itentsities with an external spectrometer and using interpolation methods.</p>
<section id="pysilsub.device.StimulationDevice">
<h2><code class="docutils literal notranslate"><span class="pre">pysilsub.device.StimulationDevice</span></code><a class="headerlink" href="#pysilsub.device.StimulationDevice" title="Permalink to this headline">¶</a></h2>
<p><em>PySilSub</em> has a generic <code class="docutils literal notranslate"><span class="pre">StimulationDevice</span></code> class that will turn spectral calibration data for any multiprimary system into a predictive model. To get started, you will need a calibration file containing spectral measurements. Each row should be a spectral measurement for a device primary at a given setting, and there should be column labels ‘Primary’ and ‘Setting’ to indicate this. Note that it will be important to include a dark measurement where LEDs are turned off (i.e., Setting = 0) to
account for ambient light in an experimental setup. If you have a <a class="reference external" href="https://www.jeti.com/">JETI</a> or <a class="reference external" href="https://www.oceaninsight.com/">OceanOptics</a> spectrometer, <a class="reference external" href="https://github.com/PyPlr/cvd_pupillometry">PyPlr</a> has some Python interfaces that may help you obtain the spectral measurements.</p>
<p>The following demonstration uses calibration data from a linear 5-primary device with 8-bit resolution depth, which is to say that the intensity of each LED is set with a number between 0 and 255. The full range of intensities was sampled in steps of 8, so there are 33 measurements for each LED.</p>
<p>The first row of the calibration file contains the wavelengths of the spectral measurements as well as columns to identify the primary and setting.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span>
    <span class="s1">&#39;../../data/BCGAR_5_Primary_8_bit_linear.csv&#39;</span><span class="p">,</span>
    <span class="n">index_col</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Primary&#39;</span><span class="p">,</span> <span class="s1">&#39;Setting&#39;</span><span class="p">]</span>
<span class="p">)</span>
<span class="n">data</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;int64&#39;</span><span class="p">)</span>
<span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;Wavelength&#39;</span>
<span class="n">data</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Wavelength</th>
      <th>380</th>
      <th>381</th>
      <th>382</th>
      <th>383</th>
      <th>384</th>
      <th>385</th>
      <th>386</th>
      <th>387</th>
      <th>388</th>
      <th>389</th>
      <th>...</th>
      <th>771</th>
      <th>772</th>
      <th>773</th>
      <th>774</th>
      <th>775</th>
      <th>776</th>
      <th>777</th>
      <th>778</th>
      <th>779</th>
      <th>780</th>
    </tr>
    <tr>
      <th>Primary</th>
      <th>Setting</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th rowspan="5" valign="top">0</th>
      <th>0</th>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>...</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>7</th>
      <td>0.000068</td>
      <td>0.000071</td>
      <td>0.000062</td>
      <td>0.000068</td>
      <td>0.000055</td>
      <td>0.000055</td>
      <td>0.000064</td>
      <td>0.000051</td>
      <td>0.000063</td>
      <td>0.000074</td>
      <td>...</td>
      <td>0.000037</td>
      <td>0.000039</td>
      <td>0.000040</td>
      <td>0.000039</td>
      <td>0.000039</td>
      <td>0.000039</td>
      <td>0.000036</td>
      <td>0.000032</td>
      <td>0.000038</td>
      <td>0.000037</td>
    </tr>
    <tr>
      <th>15</th>
      <td>0.000137</td>
      <td>0.000141</td>
      <td>0.000123</td>
      <td>0.000136</td>
      <td>0.000109</td>
      <td>0.000111</td>
      <td>0.000127</td>
      <td>0.000101</td>
      <td>0.000126</td>
      <td>0.000148</td>
      <td>...</td>
      <td>0.000074</td>
      <td>0.000077</td>
      <td>0.000080</td>
      <td>0.000079</td>
      <td>0.000078</td>
      <td>0.000078</td>
      <td>0.000072</td>
      <td>0.000064</td>
      <td>0.000075</td>
      <td>0.000075</td>
    </tr>
    <tr>
      <th>23</th>
      <td>0.000205</td>
      <td>0.000212</td>
      <td>0.000185</td>
      <td>0.000204</td>
      <td>0.000164</td>
      <td>0.000166</td>
      <td>0.000191</td>
      <td>0.000152</td>
      <td>0.000189</td>
      <td>0.000222</td>
      <td>...</td>
      <td>0.000111</td>
      <td>0.000116</td>
      <td>0.000120</td>
      <td>0.000118</td>
      <td>0.000117</td>
      <td>0.000117</td>
      <td>0.000108</td>
      <td>0.000096</td>
      <td>0.000113</td>
      <td>0.000112</td>
    </tr>
    <tr>
      <th>31</th>
      <td>0.000274</td>
      <td>0.000282</td>
      <td>0.000247</td>
      <td>0.000272</td>
      <td>0.000219</td>
      <td>0.000222</td>
      <td>0.000254</td>
      <td>0.000202</td>
      <td>0.000252</td>
      <td>0.000296</td>
      <td>...</td>
      <td>0.000148</td>
      <td>0.000154</td>
      <td>0.000160</td>
      <td>0.000158</td>
      <td>0.000157</td>
      <td>0.000156</td>
      <td>0.000144</td>
      <td>0.000128</td>
      <td>0.000151</td>
      <td>0.000149</td>
    </tr>
    <tr>
      <th>...</th>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th rowspan="5" valign="top">4</th>
      <th>223</th>
      <td>0.003027</td>
      <td>0.003555</td>
      <td>0.003159</td>
      <td>0.003563</td>
      <td>0.002712</td>
      <td>0.002951</td>
      <td>0.002827</td>
      <td>0.002159</td>
      <td>0.003197</td>
      <td>0.003623</td>
      <td>...</td>
      <td>0.001990</td>
      <td>0.002227</td>
      <td>0.002264</td>
      <td>0.002182</td>
      <td>0.002558</td>
      <td>0.002361</td>
      <td>0.002268</td>
      <td>0.001905</td>
      <td>0.002162</td>
      <td>0.002360</td>
    </tr>
    <tr>
      <th>231</th>
      <td>0.003135</td>
      <td>0.003682</td>
      <td>0.003271</td>
      <td>0.003690</td>
      <td>0.002808</td>
      <td>0.003056</td>
      <td>0.002928</td>
      <td>0.002237</td>
      <td>0.003311</td>
      <td>0.003753</td>
      <td>...</td>
      <td>0.002061</td>
      <td>0.002306</td>
      <td>0.002345</td>
      <td>0.002259</td>
      <td>0.002649</td>
      <td>0.002446</td>
      <td>0.002349</td>
      <td>0.001973</td>
      <td>0.002239</td>
      <td>0.002445</td>
    </tr>
    <tr>
      <th>239</th>
      <td>0.003243</td>
      <td>0.003809</td>
      <td>0.003384</td>
      <td>0.003817</td>
      <td>0.002905</td>
      <td>0.003162</td>
      <td>0.003029</td>
      <td>0.002314</td>
      <td>0.003426</td>
      <td>0.003882</td>
      <td>...</td>
      <td>0.002132</td>
      <td>0.002386</td>
      <td>0.002426</td>
      <td>0.002337</td>
      <td>0.002741</td>
      <td>0.002530</td>
      <td>0.002430</td>
      <td>0.002041</td>
      <td>0.002316</td>
      <td>0.002529</td>
    </tr>
    <tr>
      <th>247</th>
      <td>0.003351</td>
      <td>0.003936</td>
      <td>0.003497</td>
      <td>0.003944</td>
      <td>0.003002</td>
      <td>0.003267</td>
      <td>0.003130</td>
      <td>0.002391</td>
      <td>0.003540</td>
      <td>0.004011</td>
      <td>...</td>
      <td>0.002203</td>
      <td>0.002465</td>
      <td>0.002507</td>
      <td>0.002415</td>
      <td>0.002832</td>
      <td>0.002614</td>
      <td>0.002511</td>
      <td>0.002109</td>
      <td>0.002394</td>
      <td>0.002613</td>
    </tr>
    <tr>
      <th>255</th>
      <td>0.003459</td>
      <td>0.004063</td>
      <td>0.003610</td>
      <td>0.004071</td>
      <td>0.003099</td>
      <td>0.003373</td>
      <td>0.003231</td>
      <td>0.002468</td>
      <td>0.003654</td>
      <td>0.004141</td>
      <td>...</td>
      <td>0.002274</td>
      <td>0.002545</td>
      <td>0.002587</td>
      <td>0.002493</td>
      <td>0.002923</td>
      <td>0.002699</td>
      <td>0.002592</td>
      <td>0.002177</td>
      <td>0.002471</td>
      <td>0.002698</td>
    </tr>
  </tbody>
</table>
<p>165 rows × 401 columns</p>
</div></div>
</div>
<p>After reading the CSV file into a <code class="docutils literal notranslate"><span class="pre">DataFrame</span></code> using pandas, we can pass the data to <code class="docutils literal notranslate"><span class="pre">StimulationDevice</span></code> along with some further information to gain access to many useful features.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pysilsub.device</span> <span class="kn">import</span> <span class="n">StimulationDevice</span>

<span class="n">device</span> <span class="o">=</span> <span class="n">StimulationDevice</span><span class="p">(</span>
    <span class="n">resolutions</span><span class="o">=</span><span class="p">[</span><span class="mi">255</span><span class="p">]</span><span class="o">*</span><span class="mi">5</span><span class="p">,</span>
    <span class="n">colors</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="s1">&#39;cyan&#39;</span><span class="p">,</span> <span class="s1">&#39;green&#39;</span><span class="p">,</span> <span class="s1">&#39;orange&#39;</span><span class="p">,</span> <span class="s1">&#39;red&#39;</span><span class="p">],</span>
    <span class="n">spds</span><span class="o">=</span><span class="n">data</span><span class="p">,</span>
    <span class="n">spd_binwidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;BCGAR (8-bit, linear)&#39;</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<p>For example, plot the spectral power distributions of all measurements.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">spd_fig</span> <span class="o">=</span> <span class="n">device</span><span class="o">.</span><span class="n">plot_spds</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/03a_stimulation_devices_6_0.png" src="_images/03a_stimulation_devices_6_0.png" />
</div>
</div>
<p>Or the gamut of the device, showing the boundaries of the colour space that can be achieved on the <a class="reference external" href="https://en.wikipedia.org/wiki/CIE_1931_color_space">CIE xy chromaticity horseshoe</a>.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">gamut_fig</span> <span class="o">=</span> <span class="n">device</span><span class="o">.</span><span class="n">plot_gamut</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/03a_stimulation_devices_8_0.png" src="_images/03a_stimulation_devices_8_0.png" />
</div>
</div>
<p>More useful, we can use <code class="docutils literal notranslate"><span class="pre">device.predict_primary_spd(...)</span></code> to predict the spectral output of the stimulation device for a chosen primary at a given setting. This method simply interpolates between the measured spectra that were provided in the calibration data. It is a workhorse method that gets called repeatedly.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">primary_spd</span> <span class="o">=</span> <span class="n">device</span><span class="o">.</span><span class="n">predict_primary_spd</span><span class="p">(</span>
    <span class="n">primary</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
    <span class="n">setting</span><span class="o">=</span><span class="mf">.5</span><span class="p">,</span>  <span class="c1"># Could also say 128</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Primary 2 (half power)&#39;</span>
<span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">primary_spd</span><span class="p">)</span>
<span class="n">primary_spd</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;W/m$^2$/nm&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">device</span><span class="o">.</span><span class="n">colors</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Wavelength
380    0.001115
381    0.001191
382    0.001198
383    0.001231
384    0.001003
         ...
776    0.000710
777    0.000693
778    0.000562
779    0.000733
780    0.000826
Name: Primary 2 (half power), Length: 401, dtype: float64
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/03a_stimulation_devices_10_1.png" src="_images/03a_stimulation_devices_10_1.png" />
</div>
</div>
<p>We can also use <code class="docutils literal notranslate"><span class="pre">device.predict_multiprimary_spd(...)</span></code> to predict the spectral output for a combination of primaries and settings. This method calls the previous method for each primary/setting pair and sums the spectral power distributions.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">half_max</span> <span class="o">=</span> <span class="p">[</span><span class="mf">.5</span><span class="p">,</span> <span class="mf">.5</span><span class="p">,</span> <span class="mf">.5</span><span class="p">,</span> <span class="mf">.5</span><span class="p">,</span> <span class="mf">.5</span><span class="p">]</span>  <span class="c1"># Same as [128, 128, 128, 128, 128]</span>
<span class="n">device_spd</span> <span class="o">=</span> <span class="n">device</span><span class="o">.</span><span class="n">predict_multiprimary_spd</span><span class="p">(</span><span class="n">half_max</span><span class="p">,</span> <span class="s1">&#39;Half max&#39;</span><span class="p">)</span>
<span class="n">device_spd</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">legend</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;W/m$^2$/nm&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Predicted output for device settings: </span><span class="si">{</span><span class="n">half_max</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Predicted output for device settings: [0.5, 0.5, 0.5, 0.5, 0.5]
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/03a_stimulation_devices_12_1.png" src="_images/03a_stimulation_devices_12_1.png" />
</div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">device.predict_multiprimary_aopic(...)</span></code> will return the photoreceptor-specific irradiances for a spectrum produced by any combination of settings. This method calls the previous method and then weights the spectrum by the photoreceptor spectral sensitivities, before summing up the values for each photoreceptor.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">device_ao</span> <span class="o">=</span> <span class="n">device</span><span class="o">.</span><span class="n">predict_multiprimary_aopic</span><span class="p">(</span><span class="n">half_max</span><span class="p">,</span> <span class="s1">&#39;Half max&#39;</span><span class="p">)</span>
<span class="n">ao_colors</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">device</span><span class="o">.</span><span class="n">aopic_colors</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
<span class="n">device_ao</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;bar&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">ao_colors</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;W/m$^2$&#39;</span><span class="p">)</span>
<span class="n">device_ao</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Photoreceptor
S     6.397388
M    10.396477
L    13.764289
R     9.699696
I     9.035714
Name: Half max, dtype: float64
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/03a_stimulation_devices_14_1.png" src="_images/03a_stimulation_devices_14_1.png" />
</div>
</div>
<p>We can also search for a spectrum based on <em>xy</em> chromaticity and luminance.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">target_xy</span><span class="o">=</span><span class="p">[</span><span class="mf">0.31271</span><span class="p">,</span> <span class="mf">0.32902</span><span class="p">]</span>
<span class="n">target_luminance</span><span class="o">=</span><span class="mf">600.</span>
<span class="n">bg</span> <span class="o">=</span> <span class="n">device</span><span class="o">.</span><span class="n">find_settings_xyY</span><span class="p">(</span><span class="n">target_xy</span><span class="p">,</span> <span class="n">target_luminance</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
basinhopping step 0: f 1.11019e-11
basinhopping step 1: f 5.7635e-08 trial_f 5.7635e-08 accepted 1  lowest_f 1.11019e-11
Requested LMS: [ 0.87374046  0.78105394  0.44556496]
Solution LMS: [ 0.87373816  0.78105248  0.44556688]
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/03a_stimulation_devices_16_1.png" src="_images/03a_stimulation_devices_16_1.png" />
</div>
</div>
<p>To summarise, <code class="docutils literal notranslate"><span class="pre">StimulationDevice</span></code> will turn the calibration data for your stimulation system into a predicitve model, which is a big step towards silent substitution. Incidentally, <code class="docutils literal notranslate"><span class="pre">StimulationDevice</span></code> is the base class for <code class="docutils literal notranslate"><span class="pre">SilentSubstitutionProblem</span></code> (described <a class="reference internal" href="03b_making_stimuli.html"><span class="doc">here</span></a>), which uses numerical optimisation and linear algebra procedures to find solutions to stimulus problems.</p>
</section>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="index.html">
              <img class="logo" src="_static/photoreceptor_characters.png" alt="Logo"/>
            </a></p>
<h1 class="logo"><a href="index.html">PySilSub</a></h1>



<p class="blurb">A Python software for performing the method of silent substitution.</p>




<p>
<iframe src="https://ghbtns.com/github-btn.html?user=PySilentSubstitution&repo=pysilsub&type=watch&count=true&size=large&v=2"
  allowtransparency="true" frameborder="0" scrolling="0" width="200px" height="35px"></iframe>
</p>





<h3>Navigation</h3>
<p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="01_background.html">Background</a></li>
<li class="toctree-l1"><a class="reference internal" href="02_installation.html">Installation</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="03_overview.html">Overview</a><ul class="current">
<li class="toctree-l2 current"><a class="current reference internal" href="#">Stimulation devices</a></li>
<li class="toctree-l2"><a class="reference internal" href="03b_making_stimuli.html">Making stimuli</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="05_examples.html">Worked examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="06_api.html">API</a></li>
<li class="toctree-l1"><a class="reference internal" href="09_funding.html">Funding</a></li>
<li class="toctree-l1"><a class="reference internal" href="10_citation.html">Citation</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="index.html">Documentation overview</a><ul>
  <li><a href="03_overview.html">Overview</a><ul>
      <li>Previous: <a href="03_overview.html" title="previous chapter">Overview</a></li>
      <li>Next: <a href="03b_making_stimuli.html" title="next chapter">Making stimuli</a></li>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2022, Joel T. Martin.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 4.4.0</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="_sources/03a_stimulation_devices.ipynb.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>